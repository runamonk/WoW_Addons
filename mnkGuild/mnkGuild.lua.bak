mnkGuild = CreateFrame('Frame')
mnkGuild.LDB = LibStub:GetLibrary("LibDataBroker-1.1")

local LibQTip = LibStub("LibQTip-1.0")


local colors 	= {}
for class,color in pairs(RAID_CLASS_COLORS) do colors[class] = string.format("%02x%02x%02x", color.r*255, color.g*255, color.b*255) end


local function MouseHandler(button, arg)  
	if IsAltKeyDown() then
		InviteUnit(arg)
	else
		SetItemRef("player:"..arg, "|Hplayer:"..arg.."|h["..arg.."|h", "LeftButton")
	end
end

local function DoOnEnter(self)
  local tooltip = LibQTip:Acquire("mnkGuildTooltip", 5, "LEFT", "LEFT","LEFT", "LEFT","LEFT", "LEFT")
  
  self.tooltip = tooltip 
  tooltip:Clear()
  if IsInGuild() then
    GuildRoster()
    
    local GuildName = GetGuildInfo("player")
    tooltip:AddHeader(GuildName)
    local l = tooltip:AddLine()
    tooltip:SetCell(l, 1, GetGuildRosterMOTD(), 5)
    tooltip:AddHeader(' ')
    tooltip:AddHeader(Color(COLOR_GOLD)..'Name', Color(COLOR_GOLD)..'Level', Color(COLOR_GOLD)..'Zone', Color(COLOR_GOLD)..'Note', Color(COLOR_GOLD)..'Rank');
    
    for i=1, GetNumGuildMembers() do
      local name, rank, rankIndex, level, class, zone, note, officernote, online, status, classFileName, achievementPoints, achievementRank, isMobile = GetGuildRosterInfo(i);
      if online then
        if status ~= "" then
          local y = tooltip:AddLine(format("|cff%s%s",colors[class:gsub(" ", ""):upper()] or "ffffff", name)..status, level, zone, note, rank)
          tooltip:SetLineScript(y, "OnMouseDown", MouseHandler, name)          
        else
          local y = tooltip:AddLine(format("|cff%s%s",colors[class:gsub(" ", ""):upper()] or "ffffff", name), level, zone, note, rank)
          tooltip:SetLineScript(y, "OnMouseDown", MouseHandler, name)
        end        
      end
    end  
  else
    tooltip:AddHeader('You are not in a guild')
  end
  tooltip:SetAutoHideDelay( .1, self )
  tooltip:SmartAnchorTo(self)
  tooltip:Show() 
end

local function DoOnClick(self)
  ToggleGuildFrame()
end

local function GetNumGuildiesOnline()
  o = 0
  for i=1, GetNumGuildMembers() do
    _, _, _, _, _, _, _, _, online, _, _, _, _, _ = GetGuildRosterInfo(i);
    
    if online then
      o=(o+1)
    end  
  end
  return o
end

function mnkGuild:DoOnEvent(event)
  if event == "PLAYER_LOGIN" then
    mnkGuild.LDB = LibStub('LibDataBroker-1.1'):NewDataObject('mnkGuild', {
        icon = "Interface\\Icons\\Inv_drink_03.blp",  
        type = 'data source',
        OnEnter = DoOnEnter,
        OnClick = DoOnClick
      })  
  end
  if IsInGuild() then
    local GuildName = GetGuildInfo("player")
    self.LDB.text = Color(COLOR_GREEN)..GuildName..": "..Color(COLOR_WHITE)..GetNumGuildiesOnline().."/"..GetNumGuildMembers()
  else
    self.LDB.text = "No Guild"
  end
end

mnkGuild:SetScript("OnEvent", mnkGuild.DoOnEvent)
mnkGuild:RegisterEvent('PLAYER_LOGIN', "DoOnEvent")
mnkGuild:RegisterEvent('GUILD_ROSTER_UPDATE', "DoOnEvent")
mnkGuild:RegisterEvent('GUILD_MOTD', "DoOnEvent")
mnkGuild:RegisterEvent('PLAYER_FLAGS_CHANGED', "DoOnEvent")
mnkGuild:RegisterEvent('PLAYER_GUILD_UPDATE', "DoOnEvent")



